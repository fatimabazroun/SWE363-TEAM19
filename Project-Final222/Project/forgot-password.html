<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password - Samra</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
        }

        .logo {
            max-width: 150px;
            margin-bottom: 1.5rem;
        }

        h2 {
            color: #333;
            margin-bottom: 0.5rem;
        }

        p {
            color: #777;
            font-size: 0.9rem;
            margin-bottom: 2rem;
        }

        .form-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
        }

        input[type="email"],
        input[type="password"] {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
        }

        button {
            width: 100%;
            padding: 0.75rem;
            background-color: #8b0000;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 1rem;
        }

        button:hover {
            background-color: #a30000;
        }

        .back-link {
            display: block;
            color: #8b0000;
            font-size: 0.9rem;
            text-decoration: none;
            margin-top: 1rem;
        }

        .message {
            font-size: 0.9rem;
            margin-bottom: 1rem;
            color: red;
        }


        .password-wrapper {
            position: relative;
            margin-bottom: 1rem;
        }

        .password-wrapper input {
            width: 100%;
            padding: 0.6rem;
            padding-right: 3rem;
            /* reserve space for the "Show" */
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
        }

        .show-hide {
            position: absolute;
            top: 50%;
            right: 0.75rem;
            transform: translateY(-50%);
            font-size: 0.85rem;
            color: #8b0000;
            cursor: pointer;
            user-select: none;
        }

        .feedback {
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
            color: #888;
        }
    </style>
</head>

<body>

    <img src="images/logo.jpg" alt="Samra Logo" class="logo">

    <div class="form-container">
        <h2>Forgot your password?</h2>
        <p>Enter your email below to reset it</p>

        <div id="step1">
            <input type="email" id="email" placeholder="Enter your email" required>
            <button onclick="sendEmail()">Send Email</button>
        </div>

        <div id="step2" style="display: none;">
            <div class="password-wrapper">
                <input type="password" id="newPassword" placeholder="New Password" required>
                <span class="show-hide" onclick="togglePassword('newPassword', this)">Show</span>
            </div>
            <div id="newPasswordFeedback" class="feedback"></div>

            <div class="password-wrapper">
                <input type="password" id="confirmPassword" placeholder="Confirm Password" required>
                <span class="show-hide" onclick="togglePassword('confirmPassword', this)">Show</span>
            </div>
            <div id="confirmPasswordFeedback" class="feedback"></div>

            <button onclick="resetPassword()">Reset Password</button>
        </div>

    </div>

    <div id="message" class="message"></div>

    <a href="creator-login.html" class="back-link">&#8592; Back to Creator Login</a>
    </div>

    <script>
        function togglePassword(id, toggleEl) {
          const input = document.getElementById(id);
          if (input.type === 'password') {
            input.type = 'text';
            toggleEl.innerText = 'Hide';
          } else {
            input.type = 'password';
            toggleEl.innerText = 'Show';
          }
        }
        
        const emailInput = document.getElementById('email');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const newPasswordFeedback = document.getElementById('newPasswordFeedback');
        const confirmPasswordFeedback = document.getElementById('confirmPasswordFeedback');
        const message = document.getElementById('message');
        
        function isValidEmail(email) {
          const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return regex.test(email);
        }
        
        // LIVE validation for email
        emailInput.addEventListener('input', () => {
          const emailVal = emailInput.value.trim();
          if (!isValidEmail(emailVal)) {
            message.style.color = 'red';
            message.textContent = "❌ Invalid email format.";
          } else {
            message.style.color = 'green';
            message.textContent = "✅ Valid email format.";
          }
        });
        
        async function sendEmail() {
          const emailVal = emailInput.value.trim();
          message.textContent = "";
          newPasswordFeedback.textContent = "";
          confirmPasswordFeedback.textContent = "";
        
          if (!isValidEmail(emailVal)) {
            message.style.color = 'red';
            message.textContent = "❌ Please enter a valid email.";
            return;
          }
        
        
          try {
            const res = await fetch('http://localhost:5000/forgot-password/check-email', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email: emailVal }),
            });
        
            const data = await res.json();
        
            if (res.ok) {
              message.style.color = "green";
              message.textContent = "✅ Email found! Now reset your password.";
              document.getElementById('step1').style.display = 'none';
              document.getElementById('step2').style.display = 'block';
            } else {
              message.style.color = "red";
              message.textContent = "❌ " + (data.message || "Email not found.");
            }
          } catch (error) {
            console.error(error);
            message.style.color = "red";
            message.textContent = "❌ Server error. Please try again.";
          }
        }
        
        newPasswordInput.addEventListener('input', () => {
          const pass = newPasswordInput.value.trim();
          if (pass.length < 8) {
            newPasswordFeedback.textContent = "❌ Password must be at least 8 characters.";
            newPasswordFeedback.style.color = "red";
            newPasswordInput.style.borderColor = "red";
          } else {
            newPasswordFeedback.textContent = "✅ Good password.";
            newPasswordFeedback.style.color = "green";
            newPasswordInput.style.borderColor = "green";
          }
        });
        
        confirmPasswordInput.addEventListener('input', () => {
          if (confirmPasswordInput.value.trim() !== newPasswordInput.value.trim()) {
            confirmPasswordFeedback.textContent = "❌ Passwords do not match.";
            confirmPasswordFeedback.style.color = "red";
            confirmPasswordInput.style.borderColor = "red";
          } else {
            confirmPasswordFeedback.textContent = "✅ Passwords match.";
            confirmPasswordFeedback.style.color = "green";
            confirmPasswordInput.style.borderColor = "green";
          }
        });
        
        async function resetPassword() {
          const newPass = newPasswordInput.value.trim();
          const confirmPass = confirmPasswordInput.value.trim();
          const emailVal = emailInput.value.trim();
        
          message.textContent = "";
          newPasswordFeedback.textContent = "";
          confirmPasswordFeedback.textContent = "";
        
          if (!newPass || !confirmPass) {
            message.style.color = 'red';
            message.textContent = "❌ Please fill out both password fields.";
            return;
          }
        
          if (newPass.length < 8) {
            message.style.color = 'red';
            message.textContent = "❌ Password must be at least 8 characters.";
            return;
          }
        
          if (newPass !== confirmPass) {
            message.style.color = 'red';
            message.textContent = "❌ Passwords do not match.";
            return;
          }
        
          try {
            const res = await fetch('http://localhost:5000/forgot-password/reset', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email: emailVal, newPassword: newPass }),
            });
        
            const data = await res.json();
        
            if (res.ok) {
              message.style.color = "green";
              message.textContent = "✅ Password reset successfully! Redirecting...";
              setTimeout(() => {
                window.location.href = "creator-login.html";
              }, 1500);
            } else {
              message.style.color = "red";
              message.textContent = "❌ " + (data.message || "Password reset failed.");
            }
          } catch (error) {
            console.error(error);
            message.style.color = "red";
            message.textContent = "❌ Server error. Please try again.";
          }
        }
        </script>
        
</body>

</html>